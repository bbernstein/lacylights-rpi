# Allow lacylights user to run systemd-run for self-updates and MCP updates
# This is needed because the lacylights service has NoNewPrivileges=true
# Also allow systemctl commands needed by update-repos.sh script
# Place this file in /etc/sudoers.d/lacylights
#
# Security: These entries use specific patterns to prevent privilege escalation:
#   - Fixed unit names (no arbitrary suffixes)
#   - Fixed timing arguments (--on-active=3s, --timer-property=AccuracySec=100ms)
#   - Only allows the validated run-update.sh script (not arbitrary commands)
#   - Wildcard only for --description (user-visible text) and script arguments
#   - The run-update.sh script validates repository names and version formats
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemd-run --unit=lacylights-self-update --description=* --on-active=3s --timer-property=AccuracySec=100ms /opt/lacylights/scripts/run-update.sh *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemd-run --unit=lacylights-mcp-update --description=* --on-active=3s --timer-property=AccuracySec=100ms /opt/lacylights/scripts/run-update.sh *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl start lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop lacylights-frontend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl start lacylights-frontend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active lacylights-frontend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl daemon-reload

# Allow update script to manage npm cache directory
# Security: Only allows the specific npm cache path, not arbitrary paths
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /home/lacylights/.npm
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /home/lacylights/.npm

# Allow update script to manage lacylights deployment directories
# Security: Restricted to specific known directories used by the update script
#   - frontend-src: deployed frontend files
#   - backend: deployed backend binary
#   - repos/*: downloaded release archives
# Note: sudoers wildcards are string patterns, not path resolution, so path traversal
# like /opt/lacylights/../etc would NOT match these patterns
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /opt/lacylights/frontend-src
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /opt/lacylights/backend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /opt/lacylights/repos/*
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /opt/lacylights/frontend-src
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /opt/lacylights/backend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /opt/lacylights/repos/*
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown lacylights\:lacylights /opt/lacylights/frontend-src
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown lacylights\:lacylights /opt/lacylights/backend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown lacylights\:lacylights /opt/lacylights/repos/*

# Allow chmod commands for frontend deployment (enables group write for pi/lacylights sharing)
# Security: Only allows group write and setgid bits, not arbitrary permission changes
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod -R g+w /opt/lacylights/frontend-src
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod g+s /opt/lacylights/frontend-src

# Allow systemctl restart for services
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart lacylights-frontend
