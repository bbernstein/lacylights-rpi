# Allow lacylights user to run systemd-run for self-updates and MCP updates
# This is needed because the lacylights service has NoNewPrivileges=true
# Also allow systemctl commands needed by update-repos.sh script
# Place this file in /etc/sudoers.d/lacylights
#
# Security: These entries use specific patterns to prevent privilege escalation:
#   - Fixed unit names (no arbitrary suffixes)
#   - Fixed timing arguments (--on-active=3s, --timer-property=AccuracySec=100ms)
#   - Only allows the validated run-update.sh script (not arbitrary commands)
#   - Wildcard only for --description (user-visible text) and script arguments
#   - The run-update.sh script validates repository names and version formats
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemd-run --unit=lacylights-self-update --description=* --on-active=3s --timer-property=AccuracySec=100ms /opt/lacylights/scripts/run-update.sh *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemd-run --unit=lacylights-mcp-update --description=* --on-active=3s --timer-property=AccuracySec=100ms /opt/lacylights/scripts/run-update.sh *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl start lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop lacylights-frontend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl start lacylights-frontend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active lacylights-frontend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl daemon-reload

# Allow update script to manage directories and ownership for npm cache and lacylights dirs
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /home/lacylights/.npm
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /opt/lacylights/*
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /home/lacylights/.npm
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /opt/lacylights/*
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown lacylights\:lacylights /opt/lacylights/*
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R [0-9]*\:[0-9]* /home/lacylights/.npm

# Allow chmod commands for frontend deployment
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod -R g+w /opt/lacylights/*
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod g+s /opt/lacylights/*

# Allow systemctl restart for services
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart lacylights-frontend
