# LacyLights Service Permissions
#
# This file grants the lacylights user permission to execute specific commands
# without requiring a password for:
# - WiFi configuration via NetworkManager (nmcli)
# - Service management for updates (systemctl)
# - Repository updates and filesystem remounting
#
# IMPORTANT: This file must be installed to /etc/sudoers.d/lacylights with:
#   sudo cp lacylights /etc/sudoers.d/
#   sudo chmod 0440 /etc/sudoers.d/lacylights
#   sudo chown root:root /etc/sudoers.d/lacylights
#
# These permissions allow the LacyLights web interface to:
# - Scan for available WiFi networks
# - Connect to WiFi networks
# - Disconnect from WiFi networks
# - Enable/disable the WiFi radio
# - Manage saved network connections
# - Update LacyLights components (stop/start services)
#
# Security Note: These commands are limited to specific LacyLights services
# and do not grant broader system access. The lacylights service runs as a
# dedicated user with limited privileges.

# Allow WiFi device management
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli device wifi *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli device set wlan* *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli device status

# Allow WiFi connection management
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli connection up *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli connection down *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli connection delete *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli connection show *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli connection add *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli connection modify *

# Allow WiFi radio control
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli radio wifi *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli radio all *

# Allow general network status queries (read-only)
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli general status
lacylights ALL=(ALL) NOPASSWD: /usr/bin/nmcli networking connectivity

# Allow repository updates via wrapper script (handles read-only filesystem remounting)
lacylights ALL=(ALL) NOPASSWD: /opt/lacylights/scripts/update-repos-wrapper.sh *

# Allow filesystem remounting for updates (used by wrapper script)
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mount -o remount\,rw /
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mount -o remount\,ro /

# Allow service management for updates (stop/start/restart LacyLights services)
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl start lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active --quiet lacylights
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop lacylights-frontend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl start lacylights-frontend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart lacylights-frontend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active lacylights-frontend
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active --quiet lacylights-frontend

# Allow systemd-run for self-updates (needed because lacylights service has NoNewPrivileges=true)
# Security: Fixed unit names, timing arguments, and only allows validated run-update.sh script
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemd-run --unit=lacylights-self-update --description=* --on-active=3s --timer-property=AccuracySec=100ms /opt/lacylights/scripts/run-update.sh *
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemd-run --unit=lacylights-mcp-update --description=* --on-active=3s --timer-property=AccuracySec=100ms /opt/lacylights/scripts/run-update.sh *

# Allow systemctl daemon-reload for service updates
lacylights ALL=(ALL) NOPASSWD: /usr/bin/systemctl daemon-reload

# Allow chown for setting file ownership during updates
# Backend binary and directory
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown lacylights\:lacylights /opt/lacylights/repos/lacylights-go/lacylights-server
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown lacylights\:lacylights /opt/lacylights/backend/lacylights-server
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown lacylights\:lacylights /opt/lacylights/backend

# Frontend and MCP directories (recursive for deployment)
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /opt/lacylights/frontend-src
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /opt/lacylights/frontend-src/*
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /opt/lacylights/mcp
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /opt/lacylights/mcp/*
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /opt/lacylights/.npm-cache
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /opt/lacylights/.npm-cache/*

# npm cache in home directory
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /home/lacylights/.npm
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /home/lacylights/.npm
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R lacylights\:lacylights /home/lacylights/.npm/*
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chown -R *\:* /home/lacylights/.npm

# Allow chmod for setting permissions during updates
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod -R g+w /opt/lacylights/frontend-src
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod -R g+w /opt/lacylights/frontend-src/*
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod g+s /opt/lacylights/frontend-src
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod -R g+w /opt/lacylights/mcp
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod -R g+w /opt/lacylights/mcp/*
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod g+s /opt/lacylights/mcp
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod -R g+w /opt/lacylights/.npm-cache
lacylights ALL=(ALL) NOPASSWD: /usr/bin/chmod g+s /opt/lacylights/.npm-cache

# Allow mkdir for creating directories during updates
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /opt/lacylights/frontend-src
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /opt/lacylights/mcp
lacylights ALL=(ALL) NOPASSWD: /usr/bin/mkdir -p /opt/lacylights/.npm-cache
